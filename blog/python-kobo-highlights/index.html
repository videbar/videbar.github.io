<!DOCTYPE html>
<html lang="en">

<head>
    <title>videbar</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="robots" content="noodp"/>

    <link rel="stylesheet" href="https://www.vide.bar/style.css">
    <link rel="stylesheet" href="https://www.vide.bar/font.css">
    <link rel="stylesheet" href="https://www.vide.bar/color/blue.css">

        <link rel="alternate" type="application/rss+xml" title="RSS" href="https://www.vide.bar/rss.xml">
    
    </head>

<body class="">
<div class="container">
    
    <header class="header">
        <div class="header__inner">
            <div class="header__logo">
                    
                <a href="https://www.vide.bar" style="text-decoration: none;">
                    <div class="logo">
                      
                            &#x2F;videbar
                        
                    </div>
                </a>
            </div>
        </div>

        
        <nav class="menu">
            <ul class="menu__inner">
                <li><a href="https://www.vide.bar">home</a></li>
            
                <li class="active"><a href="https://www.vide.bar/blog">blog</a></li>
            
                <li><a href="https://www.vide.bar/rss.xml">rss feed</a></li>
            
                <li><a href="https://www.vide.bar/blog-archive">blog archive</a></li>
            
                <li><a href="https://github.com/videbar" target="_blank" rel="noopener noreferrer">github</a></li>
            </ul>
        </nav>
    
    
        
    </header>
    

    <div class="content">
        
    <div class="post">
        
    <h1 class="post-title"><a href="https://www.vide.bar/blog/python-kobo-highlights/">Building a Python CLI application to manage my bookmarks</a></h1>
    <div class="post-meta-inline">
        
    <span class="post-date">
            2022-06-20
        </span>

    </div>

    

        
        <div class="post-content">
            <p>Recently, I have started to highlight text in my Kobo ereader as I go through a book.
Once I've created a few bookmarks, I would like to somehow import them to my computer,
ideally in a format such as markdown (since I like to use <a href="https://obsidian.md/">Obsidian</a> to organise my notes), so I built <a href="https://github.com/videbar/kobo-highlights">a small program</a> do it.</p>
<span id="continue-reading"></span><h1 id="my-ereader-bookmarks">My ereader bookmarks</h1>
<p>To be more specific about what I wanted, my erader has the option of selecting parts
of the text in a book and highlighting it. This highlight is then saved and,
in my ereader, I can check all the text that I have highlighted for a given book.
It's also possible to add annotations to the highlighted text. This annotations are
free text that is linked to the highlight and that can be access from the erader menu
as well.</p>
<p>The problem is that I couldn't find a way of taking these bookmarks (the highlighted
text and the potential annotations) out of the ereader and into my computer. Ideally,
I would have some program that I could run on my computer when my ereader is connected;
this program would be able to understand the bookmarks in the ereader, get both the
highlights and the annotations, and understand from which book they are coming from.
Then it would group them in a convenient format.</p>
<h1 id="designing-the-application">Designing the application</h1>
<p>Since I could not find anything close to what I wanted, I decided to build my own
application. It could be a CLI application written in Python using <a href="https://typer.tiangolo.com/">Typer library</a>. I had used Typer before and I knew it works very well for
this kind of small CLI utilities. I also could used <a href="https://github.com/Textualize/rich">Rich</a> to have a somewhat nice interface. I have been
wanting to try it out for some time and this seems like a good project to give it a go.</p>
<p>The other thing I needed was a way of retrieving the necessary information from my
ereader, this is, I needed a way for my program to obtain a list of the bookmarks
in my ereader, the highlighted text, and the potential annotations. It also needed
to know to which book each bookmark corresponded to (the book title and author). I
started looking  and I found a few website like <a href="https://www.epubor.com/export-kobo-highlights-and-notes.HTML">this one</a> that explain that you can
easily export your bookmarks as a <code>.txt</code> file by changing the configuration
of the ereader. It would be easy to take this <code>.txt</code> file, parse it to extract the
information I wanted, and format it into something like markdown.</p>
<p>But as I looked into this in more detailed, it was clear that it was not a good
approach. For once, in order to create the <code>.txt</code> files, I would need to select each
book in my ereader and tell it to export the highlights before my computer could 
retrieve them. This is not a major problem, but a minor annoyance. The main issue was
that the file containing the bookmarks didn't appear to have a proper structure.
All bookmarks from the same book would be added to a single file without any separator
between them beyond a few empty lines (the number of empty lines
wasn't consistent either). What's more, if the bookmark had annotations, the
annotation text would mix with the highlighted text. Because all of this, parsing the
contents of the <code>.txt</code> file to retrieve the bookmarks in a somewhat general way would
be nearly impossible.</p>
<p>When I realised this, I started digging around at the files in my ereader and I found a
<code>KoboReader.sqlite</code> file. This file corresponds to a <a href="https://www.sqlite.org/fileformat2.html">SQLite database</a> and, after inspecting the database, I found
out plenty of information. Notably, there were two tables that could be useful for
this project. The first one was a Bookmark table that looks like this (here only the
relevant columns are shown):</p>
<table><thead><tr><th style="text-align: center">VolumeID</th><th style="text-align: center">Text</th><th style="text-align: center">Annotation</th><th style="text-align: center">UUID</th></tr></thead><tbody>
<tr><td style="text-align: center">&lt;ebook file path&gt;</td><td style="text-align: center">&lt;highlighted text&gt;</td><td style="text-align: center">&lt;annotated text&gt;</td><td style="text-align: center">&lt;universally unique identifier&gt;</td></tr>
<tr><td style="text-align: center">...</td><td style="text-align: center">...</td><td style="text-align: center">...</td><td style="text-align: center">...</td></tr>
<tr><td style="text-align: center">...</td><td style="text-align: center">...</td><td style="text-align: center">...</td><td style="text-align: center">...</td></tr>
</tbody></table>
<p>I could easily query this table from my application to obtain the necessary information
using <a href="https://docs.python.org/3/library/sqlite3.html">a SQLite libary</a>. Since this is
a proper database, instead of a simple <code>.txt</code> file, no parsing is necessary. I noticed
that, in the Bookmark table, some rows didn't have any data in the <code>Text</code>, nor in the
<code>Annotation</code> entries. I deduced that these correspond to bookmarking a page, which is
something I can also do on my ereader. I was not interested in this kind of bookmarks,
but I should be able to easily ignore them when querying the database.</p>
<p>The other interesting table that I found in <code>KoboReader.sqlite</code> is a Content table
that contains information about all the books that are currently stored in the ereader.
It looks like this (again, some irrelevant columns have are not being shown):</p>
<table><thead><tr><th style="text-align: center">ContentID</th><th style="text-align: center">Title</th><th style="text-align: center">Attribution</th><th style="text-align: center">ContentType</th></tr></thead><tbody>
<tr><td style="text-align: center">&lt;ebook file path&gt;</td><td style="text-align: center">&lt;book title&gt;</td><td style="text-align: center">&lt;book author&gt;</td><td style="text-align: center">&lt;type of entry&gt;</td></tr>
<tr><td style="text-align: center">...</td><td style="text-align: center">...</td><td style="text-align: center">...</td><td style="text-align: center">...</td></tr>
<tr><td style="text-align: center">...</td><td style="text-align: center">...</td><td style="text-align: center">...</td><td style="text-align: center">...</td></tr>
</tbody></table>
<p>The column <code>ContentID</code> in the <code>content</code> table represents the same information as the
<code>VolumeID</code> in the <code>Bookmark</code> table. The column <code>ContentType</code> is an interesting one.
There are two types of entries in the content table, general information about each
book and information regarding specific chapters or section of the book, the former
have a value of <code>6</code> for the <code>ContentType</code> and the later have a <code>9</code> (I don't know the
reason for this numbering choice).</p>
<p>For the entries that correspond to general information about books, the columns <code>Title</code>
and <code>Attribution</code> contain the book title and author respectively.</p>
<p>So the plan was clear, use Typer to build a CLI application that could query the SQLite
database, retrieve the bookmarks and book information, and format them nicely in a
makdown document. It would also be able to display information about the bookmarks and
for that I would use Rich. The application will also need a way of keeping track of
the bookmarks that it has already imported; so that it is able to only import new
bookmarks when it's called multiple times.</p>
<h1 id="the-technical-details">The technical details</h1>
<p>So that's exactly what I built. I called the final application Kobo Highlights, and it
can be called from the terminal using the command <code>kh</code>. It supports the following
subcommands:</p>
<ul>
<li>
<p><code>kh config</code>: It is used to manage the configuration of the program. Basically Kobo
Highlights needs to know two things, where my erader is mounted and where I want the
final markdown files to be created. These two things are stored in a config file, and
the <code>config</code> command can be used to see the current configuration and to create a new
one. Kobo Highlights can't work with a proper configuration, so if it is called and it
can't find one, it will prompt the user to create one interactively.</p>
</li>
<li>
<p><code>kh ls</code>: It lists the available bookmarks. By default it will only list new
bookmarks, this is, bookmarks that are on the ereader but have not been imported yet.
The <code>-all</code> flag can be use to list all the bookmarks in the ereader instead,
independently of whether or not they have been imported.
The <code>ls</code> command will list, for each bookmark, the highlighted text, the annotation
(in case there's one), the book title and author, and the ID. The ID of the bookmark
is the <code>UUID</code> assigned to the bookmark by the ereader, which turned out to be a very
useful field.
The book title and author are queried from the content table. To do so, a query is
performed with the right <code>ContentID</code> (the <code>VolumeID</code> value from the bookmark table)
and forcing <code>ContentType</code> to be <code>6</code>.</p>
</li>
<li>
<p><code>kh import</code>: Finally, the main point of the tool, this command will import a set
of bookmarks and store them as a markdown document. The markdown documents will
follow a simple structure in which the highlighted text is included as a block
quote, and the potential annotations are added bellow. The <code>import</code> command can be
called with multiple options; it supports <code>all</code> to import all bookmarks in the ereader
and <code>new</code> to only import the ones that weren't imported before, but it also supports
being called with a list of IDs, a book title, or a book author.</p>
</li>
</ul>
<p>One thing I had to consider was how to keep track of the bookmarks that have already
been imported. Originally I queried the markdown document and looked at the text 
inside each block quote. This worked ok, but it had some problems.</p>
<p>The main issue is that it's not easy to parse markdown text. This is because markdown
is a format designed for human readability, unlike JSON, which is designed mainly
for serialization. In order to parse the markdown files, I first convert them to html
and then use <a href="https://www.crummy.com/software/BeautifulSoup/bs4/doc/">Beautiful Soup</a>
to parse the html text. This works fine in most cases but it's only a matter of time
before some estrange edge case breaks it.</p>
<p>The other issue is that, sometimes, I may want to modify the highlighted text. An
example of this is when I highlight part of a sentence and I want to add some
punctuation or change the capitalization. The current markdown-to-html parser allows to
add emphasis to the highlighted text, but, as soon as you modified a single character,
it will not recognize the bookmark, and it will re-import it the next time it's called.</p>
<p>In order to solve these issues, I got rid of my markdown parser and instead
store the IDs (I told you they are a useful field) of all the bookmarks that have been
imported in a hidden JSON file in the same directory as all the markdown files. Then,
every time the application needs to know what highlighted have been imported, all it
needs to do is load this JSON file.</p>
<p>Another thing to point out is that when querying the ereader database, the application
doesn't access the SQLite file directly, instead it creates a local copy of the file
in the computer and queries the data from the copy. Once it's done, it deletes the
local file. The reason for doing this is that the database doesn't only contain the
Bookmarks, but also a lot of data that seems important for the ereader's functionality.
Since I'm not that familiar with SQLite, I'd rather not interact with the ereader
database directly, but use a copy instead, just in case.</p>
<h1 id="where-to-find-the-program">Where to find the program</h1>
<p>In case you want to have a look or try Kobo highlights, <a href="https://pypi.org/project/kobo-highlights/">it is available on pypi</a> and the entire source code is hosted
<a href="https://github.com/videbar/kobo-highlights">in github</a>.</p>

        </div>

        
        <div class="pagination">
            <div class="pagination__title">
                <span class="pagination__title-h">Thanks for reading! Read other posts?</span>
                <hr />
            </div>
            <div class="pagination__buttons">
                
                    <span class="button next">
                        <a href="https://www.vide.bar/blog/rust-microbit-game-of-life/">
                            <span class="button__text">Implemeting Conway&#x27;s Game of Life on a Microbit board using Rust </span>&nbsp;
                            <span class="button__icon">→</span>
                        </a>
                    </span>
                </div>
        </div>
    
    </div>

    </div>

    
    <footer class="footer">
        <div class="footer__inner">
                <div class="copyright">
                        <span>© 
    2024
 Powered by <a href="https://www.getzola.org/">Zola</a></span>
                    <span class="copyright-theme">
                        <span class="copyright-theme-sep">:: </span>
                        <a href="https://github.com/videbar/videbar.github.io">Source code</a>
                        <span class="copyright-theme-sep">:: </span>
                        Theme based on: <a href="https://github.com/pawroman/zola-theme-terminimal/">Terminimal</a>
                    </span>
                </div>
            </div>
    </footer>
    

</div>
</body>

</html>
